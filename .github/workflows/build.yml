name: Build WhisperBridge

on:
  push:
    tags:
      - 'v*'                # Standard tags like v1.0.0
      - 'WhisperBridge-v*'  # Custom tags like WhisperBridge-v1.2.4

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # For setuptools_scm version detection
        fetch-tags: true

    - name: Fetch tags explicitly
      run: |
        git fetch --tags --force
        echo "Available tags:"
        git tag -l
        echo "Current ref: ${{ github.ref }}"
        echo "Git describe:"
        git describe --tags --always

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install UPX
      shell: pwsh
      run: |
        choco install upx -y
        # Find the actual path to upx.exe
        $upxPath = (Get-Command upx).Source | Split-Path -Parent
        echo "UPX_DIR=$upxPath" >> $env:GITHUB_ENV

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller setuptools_scm

    - name: Generate version file
      shell: pwsh
      run: |
        $version = python -c "from setuptools_scm import get_version; print(get_version())"
        Write-Host "Detected version: $version"
        $versionFile = "src/whisperbridge/_version.py"
        New-Item -ItemType Directory -Force -Path (Split-Path $versionFile) | Out-Null
        $parts = $version -split '\.'
        $major = if ($parts.Length -gt 0) { $parts[0] } else { '0' }
        $minor = if ($parts.Length -gt 1) { $parts[1] } else { '0' }
        $patch = if ($parts.Length -gt 2) { ($parts[2] -split '[+\-]')[0] } else { '0' }
        $content = "# Generated by CI`n__version__ = version = '$version'`n__version_tuple__ = version_tuple = ($major, $minor, $patch)`n"
        Set-Content -Path $versionFile -Value $content -Encoding utf8
        Write-Host "Created $versionFile"
        Get-Content $versionFile

    - name: Build executable
      shell: pwsh
      run: |
        python build.py --spec WhisperBridge.spec --ocr --upx --upx-dir "$env:UPX_DIR" --mode onefile

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/WhisperBridge.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
